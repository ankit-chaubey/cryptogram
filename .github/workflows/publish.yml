name: Publish to PyPI

# Triggered manually only — go to Actions → Publish to PyPI → Run workflow.
# Requires a PyPI Trusted Publisher configured for this repo:
#   PyPI project → Publishing → Add a new publisher
#     Owner:      <your-github-username-or-org>
#     Repository: cryptogram
#     Workflow:   publish.yml
#     Environment: pypi   ← must match the `environment:` name below
on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag / version to publish (e.g. v1.0.0). Must exist."
        required: true
        type: string

jobs:
  # ── 1. Build wheels for all platforms ───────────────────────────────────
  build-wheels:
    name: Build wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}

      - uses: pypa/cibuildwheel@v2.17.0
        env:
          CIBW_BUILD: cp38-* cp39-* cp310-* cp311-* cp312-*
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_ARCHS_WINDOWS: "AMD64"
          CIBW_TEST_COMMAND: "python {project}/tests/test_cryptogram.py"
          CIBW_BEFORE_BUILD: "pip install cryptography || true"
          CIBW_BEFORE_TEST:  "pip install cryptography || true"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  # ── 2. Build the source distribution ────────────────────────────────────
  build-sdist:
    name: Build sdist
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build sdist
        run: |
          pip install build
          python -m build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  # ── 3. Upload everything to PyPI via Trusted Publisher ──────────────────
  publish:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest

    # The environment name must match what you configured on PyPI.
    environment:
      name: pypi
      url: https://pypi.org/project/cryptogram/

    # Required for Trusted Publisher (OIDC) — no API token needed.
    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
